{% import "macros/components.html" as components %}
{% import "macros/icons.html" as icons %}
{% import "macros/forms.html" as forms %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Portal</title>
    <link rel="stylesheet" href="/css/apply_section.css" />
    <link rel="stylesheet" href="/css/forms.css" />
    <link rel="stylesheet" href="/css/button.css">
    <link rel="stylesheet" href="/css/stepper.css">
</head>

<body>
    <div class="container-background-jobs">
        <div class="grid-container">
            <div class="container-child">
                {{ components::stepper(current_step=2) }}

                <div class="main-container">
                    <div class="application-form">
                        <div class="left-panel-child">
                            <div class="back-button" role="button" tabindex="0" onclick="history.back()">
                                {{ icons::back_icon() | safe }}
                            </div>
                            <div class="page-title">Application Page</div>
                        </div>

                        <form id="resume-form" class="form-section" action="/apply" method="post">
                            <input type="hidden" id="selectedJobId" name="job" value="">
                            <div class="job-meta-details">
                                <p class="job-title">Software Eng II @Uber - Code Review</p>
                                <p class="job-date">June 23rd, 2025</p>
                                {{ forms::select_input_ref(
                                    name="event",
                                    label="",
                                    options=event_options,
                                    placeholder="No Events Available",
                                )}}
                            </div>
                            <div class="form-fields application-fields">
                                {{ forms::text_input(
                                    name="name",
                                    label="Name",
                                    placeholder="Enter your name"
                                ) }}

                                {{ forms::text_input(
                                    name="github",
                                    label="GitHub",
                                    placeholder="GitHub URL",
                                    type="url",
                                    pattern="https?://(www\.)?github\.com/[A-Za-z0-9_.-]+/?",
                                    title="Enter a valid GitHub profile URL (e.g., https://github.com/username)"
                                ) }}

                                {{ forms::text_input(
                                    name="email",
                                    label="Email",
                                    type="email",
                                    placeholder="Email",
                                    autocomplete="email",
                                    pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$",
                                    title="Enter a valid email address"
                                ) }}

                                {{ forms::textarea(name="whatProgramming", label="What got you started in programming?") }}
                                {{ forms::textarea(name="whyProgramming", label="Why do you want to be a programmer?") }}
                                {{ forms::textarea(name="whenStart", label="When/where did you start?") }}
                                {{ forms::textarea(name="whoProgram", label="Who got you into programming?") }}
                                {{ forms::textarea(name="whatProject", label="What would be your ultimate project right now?") }}
                                {{ forms::textarea(name="proudWork", label="What is one piece of work youâ€™re proud of?") }}
                                {{ forms::textarea(name="skillsToMaster", label="What skills do you want to master in the next 5 years?") }}
                                {{ forms::textarea(name="oncallHorror", label="Any on-call horror stories?") }}
                                {{ forms::textarea(name="focusStrategy", label="What strategies do you use to stay focused while working on a task?") }}

                                {{ forms::text_input(
                                    name="supportSystem",
                                    label="What support system do you rely on to stay focused, and how can we help improve it?"
                                ) }}

                                {{ forms::text_input(
                                    name="comfortFood",
                                    label="What's your favorite comfort food and why?"
                                ) }}

                                {{ forms::text_input(
                                    name="weekendRoutine",
                                    label="How do you typically spend your weekends?"
                                ) }}

                                {{ forms::text_input(
                                    name="travelDestination",
                                    label="If you could travel anywhere, where would you go?"
                                ) }}
                                <div class="application-submit">
                                    {% set arrow_right_svg = icons::arrow_right() %}
                                    {{ components::button(label="SUBMIT", form="resume-form", type="submit", primary=true, size="big", backIcon=arrow_right_svg) }}
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="circular-progressbar-wrapper">
                        <div class="progress-container">
                            <svg class="progress-ring" width="300" height="300">
                                <circle class="progress-ring__background"></circle>
                                <circle class="progress-ring__progress"></circle>
                            </svg>
                            <div class="inner-circle"></div>
                            <div class="progress-text">Form Completion: [ 0% ]</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="join-community-btn">
        {% set discord_svg = icons::discord_large_icon() %}
        {{ components::button(
          label="Join the community",
          type="button",
          primary=false,
          size="small",
          backIcon=discord_svg,
          extra_attrs='onclick="openDiscordInvite()"'
        ) }}
    </div>

    <script>
        // Set selectedJobId from localStorage
        const selectedJobIdInput = document.getElementById('selectedJobId');
        const storedJobId = localStorage.getItem('selectedJobId');
        if (storedJobId) {
            selectedJobIdInput.value = storedJobId;
        }

        document.querySelector('.back-button').addEventListener('click', function() {
            console.log('Back button clicked');
            // Add your navigation logic here
        });

        // Handle form submission with AJAX
        document.getElementById('resume-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const formData = new FormData(this);
            const urlEncodedData = new URLSearchParams(formData);
            
            try {
                const response = await fetch('/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: urlEncodedData
                });
                
                const result = await response.json();
                
                if (result.success && result.application_id) {
                    // Store the application ID in localStorage
                    localStorage.setItem('applicationId', result.application_id);
                    console.log('Application ID stored:', result.application_id);
                    
                    // Redirect to the queue page
                    if (result.redirect) {
                        window.location.href = result.redirect;
                    }
                } else {
                    console.error('Application submission failed:', result.error);
                    alert('Failed to submit application. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('An error occurred while submitting the application.');
            }
        });

        // Add smooth scrolling for form fields
        const formFields = document.querySelector('.form-fields');
        let isScrolling = false;

        formFields.addEventListener('scroll', function() {
            if (!isScrolling) {
                window.requestAnimationFrame(function() {
                    isScrolling = false;
                });
                isScrolling = true;
            }
        });

        // Progress bar functionality
        function updateProgressBar() {
            const allInputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea');
            const totalFields = allInputs.length;
            let filledFields = 0;

            allInputs.forEach(input => {
                if (input.value.trim() !== '') {
                    filledFields++;
                }
            });

            const progressPercentage = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;
            
            const progressText = document.querySelector('.progress-text');
            progressText.textContent = `Form Completion: [ ${progressPercentage}% ]`;

            const progressCircle = document.querySelector('.progress-ring__progress');
            if (progressCircle) {
                const radius = 135;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference - (progressPercentage / 100) * circumference;
                
                progressCircle.style.strokeDasharray = circumference;
                progressCircle.style.strokeDashoffset = offset;
            }
        }

        updateProgressBar();

        // Add event listeners to all form inputs
        document.addEventListener('DOMContentLoaded', function() {
            const allInputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea');
            
            allInputs.forEach(input => {
                input.addEventListener('input', updateProgressBar);
                input.addEventListener('blur', updateProgressBar);
            });
        });

        function openDiscordInvite() {
            window.open('https://discord.com/invite/XJ2PBd3F', '_blank', 'noopener,noreferrer');
        }
    </script>
</body>
</html>